# ============================================
# White-Label Limo Service - Coolify Docker Compose
# Use for: Coolify-managed deployments
# ============================================
# Coolify handles:
#   - Container orchestration
#   - SSL certificates  
#   - Reverse proxy
#   - Environment variables
# 
# You must provide:
#   - External PostgreSQL database (Neon, Supabase, etc.)
#   - External S3 storage (MinIO, AWS S3, etc.)
# ============================================

version: '3.9'

services:
  # ========================================
  # Main Application (Coolify manages this)
  # ========================================
  app:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
    container_name: ${COOLIFY_CONTAINER_NAME:-limo-app}
    restart: unless-stopped
    environment:
      # Core Settings
      NODE_ENV: production
      PORT: 5000
      HOST: 0.0.0.0
      
      # Database (REQUIRED - External managed PostgreSQL)
      # Example: postgresql://user:pass@ep-xxx.us-east-1.neon.tech/dbname?sslmode=require
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL required - use Neon or Supabase}
      
      # Session & Security (REQUIRED)
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET required}
      
      # Object Storage (REQUIRED - choose MinIO or S3)
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-minio}
      
      # MinIO Settings (if using MinIO)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-}
      MINIO_BUCKET: ${MINIO_BUCKET:-limo-uploads}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-true}
      
      # AWS S3 Settings (if using AWS S3)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      
      # Payment (Optional - leave empty to disable Stripe)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      VITE_STRIPE_PUBLIC_KEY: ${VITE_STRIPE_PUBLIC_KEY:-}
      
      # Email (Optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Limo Service}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
      
      # SMS (Optional)
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
      
      # APIs (Optional)
      TOMTOM_API_KEY: ${TOMTOM_API_KEY:-}
      RAPIDAPI_KEY: ${RAPIDAPI_KEY:-}
      
      # Domain (Coolify sets COOLIFY_URL automatically)
      REPLIT_DEV_DOMAIN: ${COOLIFY_URL:-${APP_DOMAIN:-}}
    ports:
      - "${APP_PORT:-5000}:5000"
    volumes:
      - uploads_data:/app/uploads
      - logs_data:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Named volumes for persistent data
volumes:
  uploads_data:
    driver: local
  logs_data:
    driver: local
