# Production Deployment Checklist

Pre-deployment verification checklist for USA Luxury Limo on Coolify.

## üìã Pre-Deployment Checklist

### 1. Environment Variables

- [ ] **DATABASE_URL** configured with URL-encoded password
  ```bash
  # Example: password "Erka75810916?" becomes:
  postgresql://postgres:Erka75810916%3F@database:5432/postgres
  ```
  - [ ] Special characters encoded (`?` ‚Üí `%3F`, `@` ‚Üí `%40`, etc.)
  - [ ] Host name correct (container name or domain)
  - [ ] Database name correct
  - [ ] Port correct (usually 5432)

- [ ] **SESSION_SECRET** set to strong random value
  ```bash
  openssl rand -base64 32
  ```

- [ ] **MinIO/Object Storage** credentials configured
  - [ ] `MINIO_ENDPOINT` (e.g., `https://minio.best-chauffeurs.com`)
  - [ ] `MINIO_ACCESS_KEY` set
  - [ ] `MINIO_SECRET_KEY` set
  - [ ] `MINIO_BUCKET` created (default: `replit`)

- [ ] **Replit Auth (OIDC)** configured
  - [ ] `ISSUER_URL` set
  - [ ] `CLIENT_ID` set
  - [ ] `CLIENT_SECRET` set

- [ ] **Admin Panel Access** configured
  - [ ] `ADMIN_PANEL_HOSTS` includes production domain
  - [ ] Format: `adminaccess.best-chauffeurs.com,localhost:5000`

- [ ] **API Keys** configured
  - [ ] `TOMTOM_API_KEY` (geocoding)
  - [ ] `AERODATABOX_API_KEY` (flight search)

- [ ] **Payment Providers** configured (at least one)
  - [ ] Stripe: `STRIPE_SECRET_KEY`, `VITE_STRIPE_PUBLIC_KEY`
  - [ ] PayPal: `PAYPAL_CLIENT_ID`, `PAYPAL_CLIENT_SECRET`
  - [ ] Square: `SQUARE_ACCESS_TOKEN`, `SQUARE_LOCATION_ID`

- [ ] **Twilio (SMS)** configured
  - [ ] `TWILIO_ACCOUNT_SID`
  - [ ] `TWILIO_AUTH_TOKEN`
  - [ ] `TWILIO_PHONE_NUMBER`

- [ ] **Email (SMTP)** configured
  - [ ] `EMAIL_HOST`
  - [ ] `EMAIL_PORT`
  - [ ] `EMAIL_USER`
  - [ ] `EMAIL_PASSWORD`
  - [ ] `EMAIL_FROM`

### 2. Coolify Configuration

- [ ] **Resource created** in Coolify
- [ ] **Git repository** connected
- [ ] **Branch** selected (main/production)
- [ ] **Docker Compose location** set to `deployment/docker-compose.yml`
- [ ] **Dockerfile location** set to `deployment/Dockerfile`
- [ ] **Network configuration**:
  - [ ] "Connect to Predefined Network" enabled
  - [ ] Correct network selected (same as PostgreSQL/MinIO)

### 3. Domain & SSL

- [ ] **Domain** added in Coolify: `adminaccess.best-chauffeurs.com`
- [ ] **DNS A Record** configured pointing to server IP
- [ ] **Caddy labels** present in docker-compose.yml
- [ ] **SSL certificate** will be auto-generated by Caddy

### 4. External Services

- [ ] **PostgreSQL container** running
  ```bash
  docker ps | grep postgres
  ```
  - [ ] Database created
  - [ ] User credentials correct
  - [ ] Accessible from app network

- [ ] **MinIO container** running
  ```bash
  curl https://minio.best-chauffeurs.com/minio/health/live
  ```
  - [ ] Bucket `replit` created
  - [ ] Access keys configured
  - [ ] Accessible from app network

### 5. Code & Files

- [ ] **Latest code** committed to git
- [ ] **No .env file** committed (security)
- [ ] **deployment/** folder complete with all files:
  - [ ] `Dockerfile`
  - [ ] `docker-compose.yml`
  - [ ] `entrypoint.sh` (executable)
  - [ ] `healthcheck.sh` (executable)
  - [ ] `.dockerignore`
  - [ ] `.env.example`

### 6. Database Migrations

- [ ] **Migration strategy** decided:
  - [ ] Auto-migrate on startup (default in `entrypoint.sh`)
  - [ ] OR manual migration before deploy

- [ ] **Drizzle schema** up to date (`shared/schema.ts`)
- [ ] **No pending schema changes** uncommitted

---

## üöÄ Deployment Steps

### Initial Deployment

1. **Complete above checklist** ‚úÖ

2. **Push code to Git:**
   ```bash
   git add .
   git commit -m "Production deployment ready"
   git push origin main
   ```

3. **In Coolify UI:**
   - Navigate to your resource
   - Click **"Deploy"** or wait for auto-deployment

4. **Monitor deployment:**
   - Watch build logs in Coolify UI
   - Wait for health check to pass (~3-6 minutes)

5. **Verify deployment:**
   ```bash
   # Health check
   curl https://adminaccess.best-chauffeurs.com/health
   
   # Expected: {"status":"ok","timestamp":"..."}
   ```

### Update Deployment

1. **Make code changes**

2. **Test locally** (optional):
   ```bash
   npm run dev
   # OR
   cd deployment/ && ./deploy.sh
   ```

3. **Commit and push:**
   ```bash
   git add .
   git commit -m "Update: description of changes"
   git push origin main
   ```

4. **Coolify auto-deploys** (or manually trigger in UI)

---

## ‚úÖ Post-Deployment Verification

### Immediate Checks (First 5 Minutes)

- [ ] **Container running:**
  ```bash
  docker ps | grep usa-luxury-limo
  ```

- [ ] **Health endpoint responding:**
  ```bash
  curl https://adminaccess.best-chauffeurs.com/health
  ```

- [ ] **HTTPS working** (no certificate errors)

- [ ] **Logs clean** (no ERROR messages):
  ```bash
  docker logs usa-luxury-limo | grep ERROR
  ```

### Functional Tests (First 30 Minutes)

- [ ] **Login system:**
  - [ ] Replit Auth working
  - [ ] Session persistence working
  - [ ] Role-based access working

- [ ] **Database connection:**
  - [ ] Can view existing data
  - [ ] Can create new records
  - [ ] Migrations applied successfully

- [ ] **Object Storage (MinIO):**
  - [ ] Can upload files (test with admin media library)
  - [ ] Can view uploaded files
  - [ ] Presigned URLs working

- [ ] **Email system:**
  - [ ] Send test email from admin settings
  - [ ] Email received successfully
  - [ ] Logo/branding correct in email

- [ ] **SMS system (if configured):**
  - [ ] Send test SMS
  - [ ] SMS received successfully

- [ ] **Payment processing:**
  - [ ] Stripe checkout working (test mode)
  - [ ] PayPal redirect working
  - [ ] Square payment working

- [ ] **Admin features:**
  - [ ] Can access admin panel
  - [ ] CMS features working
  - [ ] User management working
  - [ ] Vehicle types CRUD working
  - [ ] Invoice system working

### Mobile & PWA (First Hour)

- [ ] **PWA installation:**
  - [ ] Install prompt shows on mobile
  - [ ] App installs successfully
  - [ ] Icons correct (from branding)

- [ ] **Mobile navigation:**
  - [ ] All pages accessible
  - [ ] Forms working
  - [ ] Camera access (for driver documents)
  - [ ] Geolocation (for booking)

---

## üêõ Common Issues & Solutions

### Issue: 502 Bad Gateway

**Causes:**
1. Container not running
2. Network misconfiguration
3. Wrong port in Caddy labels

**Solutions:**
1. Check container: `docker ps | grep usa-luxury-limo`
2. Check logs: `docker logs usa-luxury-limo`
3. Verify network: `docker inspect usa-luxury-limo | grep NetworkMode`
4. Check Caddy labels: `docker inspect usa-luxury-limo | grep caddy`

### Issue: Database Connection Failed

**Causes:**
1. DATABASE_URL special characters not encoded
2. PostgreSQL container not accessible
3. Wrong credentials

**Solutions:**
1. Encode special chars: `?` ‚Üí `%3F`
2. Test connectivity: `docker exec usa-luxury-limo ping postgres-container`
3. Verify credentials in PostgreSQL container

### Issue: MinIO 503 Error

**Causes:**
1. MinIO container not running
2. Wrong endpoint URL
3. Network not configured

**Solutions:**
1. Check MinIO: `curl https://minio.best-chauffeurs.com/minio/health/live`
2. Verify `MINIO_ENDPOINT` in env vars
3. Test upload from admin panel

### Issue: Health Check Failing

**Causes:**
1. App not starting (check logs)
2. Health check timeout too short
3. Migration errors

**Solutions:**
1. View logs: `docker logs usa-luxury-limo`
2. Increase `start_period` in docker-compose.yml
3. Fix migration errors, redeploy

---

## üîí Security Verification

- [ ] **HTTPS enforced** (HTTP redirects to HTTPS)
- [ ] **Security headers** present:
  ```bash
  curl -I https://adminaccess.best-chauffeurs.com
  # Should include: X-Frame-Options, X-Content-Type-Options
  ```
- [ ] **Admin panel** accessible only from allowed hosts
- [ ] **No secrets** in git repository
- [ ] **No secrets** in container logs
- [ ] **Database backups** configured (external PostgreSQL)
- [ ] **Regular updates** scheduled (security patches)

---

## üìä Monitoring Setup (Optional)

### Coolify Built-in

- [ ] **Resource metrics** enabled in Coolify UI
- [ ] **Deployment notifications** configured
- [ ] **Log retention** configured

### External (Recommended)

- [ ] **Uptime monitoring** (UptimeRobot, etc.)
  - [ ] Monitor: `https://adminaccess.best-chauffeurs.com/health`
  - [ ] Alert on: 5xx errors, slow response

- [ ] **Error tracking** (Sentry, etc.)
  - [ ] Frontend errors captured
  - [ ] Backend errors captured
  - [ ] Alerts configured

- [ ] **Database monitoring**
  - [ ] Neon dashboard configured
  - [ ] Query performance monitored

---

## üìù Rollback Plan

If deployment fails:

1. **In Coolify UI:**
   - Navigate to "Deployments" tab
   - Click on previous successful deployment
   - Click "Redeploy" to rollback

2. **Via Git:**
   ```bash
   git revert HEAD
   git push origin main
   # Coolify auto-deploys previous version
   ```

3. **Emergency:**
   - Stop new deployment
   - Start old container manually
   - Investigate logs

---

## ‚úÖ Sign-Off

Deployment completed by: ________________

Date: ________________

Issues encountered: ________________

Resolution: ________________

Next review date: ________________

---

**Last Updated:** November 2025

Use this checklist for every production deployment to ensure consistency and reliability.
