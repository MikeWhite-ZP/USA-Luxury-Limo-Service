# ============================================
# White-Label Limo Service - App Deployment
# ============================================
# Deploy this for EACH company/tenant
# Connects to central PostgreSQL and MinIO
# ============================================
# Prerequisites:
#   1. Central infrastructure running (postgres + minio)
#   2. Tenant provisioned with provision-tenant.sh
#   3. .env file with tenant credentials
# ============================================

services:
  app:
    build:
      context: ../..
      dockerfile: deployment/app/Dockerfile
    container_name: ${COMPANY_SLUG:-limo}-app
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      HOST: 0.0.0.0
      COMPANY_SLUG: ${COMPANY_SLUG}
      DATABASE_URL: ${DATABASE_URL}
      SESSION_SECRET: ${SESSION_SECRET}
      STORAGE_PROVIDER: minio
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      VITE_STRIPE_PUBLIC_KEY: ${VITE_STRIPE_PUBLIC_KEY:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Limo Service}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
      TOMTOM_API_KEY: ${TOMTOM_API_KEY:-}
      RAPIDAPI_KEY: ${RAPIDAPI_KEY:-}
      REPLIT_DEV_DOMAIN: ${APP_DOMAIN:-}
    ports:
      - "${APP_PORT:-5000}:5000"
    volumes:
      - app_uploads:/app/uploads
      - app_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  app_uploads:
    driver: local
  app_logs:
    driver: local
