version: '3.9'
# Define networks for internal service communication
networks:
  coolify:
    # This must be defined as external, as specified by Coolify
    external: true
  internal_backend:
    # A local network for the database and storage services
    driver: bridge

services:
  # PostgreSQL Database Service
  database:
    image: postgres:15-alpine
    container_name: best-chauffeurs-database
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      # Persistent storage for database data
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal_backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Object Storage Service (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: best-chauffeurs-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-${MINIO_ACCESS_KEY:-minioadmin}}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-${MINIO_SECRET_KEY}}
    volumes:
      # Persistent storage for files
      - minio_data:/data
    networks:
      - internal_backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # The main Best-Chauffeurs application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: best-chauffeurs-app
    labels:
      # Labels for Caddy/Coolify reverse proxy and SSL
      - 'caddy=best-chauffeurs.com, www.best-chauffeurs.com, adminaccess.best-chauffeurs.com'
      - 'caddy.reverse_proxy={{upstreams 5000}}'
    environment:
      - NODE_ENV=production
      - PORT=5000
      - 'DATABASE_URL=${DATABASE_URL}'
      - 'STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}'
      - 'VITE_STRIPE_PUBLIC_KEY=${VITE_STRIPE_PUBLIC_KEY}'
      - 'SESSION_SECRET=${SESSION_SECRET}'
      - 'MINIO_ENDPOINT=http://minio:9000'
      - 'MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}'
      - 'MINIO_SECRET_KEY=${MINIO_SECRET_KEY}'
      - 'MINIO_BUCKET=${MINIO_BUCKET:-best-chauffeurs}'
      - 'SMTP_HOST=${SMTP_HOST}'
      - 'SMTP_PORT=${SMTP_PORT}'
      - 'SMTP_SECURE=${SMTP_SECURE}'
      - 'SMTP_USER=${SMTP_USER}'
      - 'SMTP_PASS=${SMTP_PASS}'
      - 'EMAIL_FROM_NAME=${EMAIL_FROM_NAME}'
      - 'EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS}'
      - 'TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}'
      - 'TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}'
      - 'TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}'
      - 'TOMTOM_API_KEY=${TOMTOM_API_KEY}'
      - 'RAPIDAPI_KEY=${RAPIDAPI_KEY}'
      - 'SETTINGS_ENCRYPTION_KEY=${SETTINGS_ENCRYPTION_KEY}'
      - 'ADMIN_PANEL_HOSTS=${ADMIN_PANEL_HOSTS:-adminaccess.best-chauffeurs.com}'
      - 'VITE_ADMIN_PANEL_HOSTS=${VITE_ADMIN_PANEL_HOSTS:-adminaccess.best-chauffeurs.com}'
      - 'API_URL=${API_URL}'
      - 'BACKEND_URL=${BACKEND_URL}'
      - 'CMS_URL=${CMS_URL}'
      - 'VITE_API_URL=${VITE_API_URL}'
      - 'VITE_BACKEND_URL=${VITE_BACKEND_URL}'
      - 'VITE_CMS_URL=${VITE_CMS_URL}'
      - 'VITE_MINIO_BUCKET=${VITE_MINIO_BUCKET}'
      - 'VITE_MINIO_ENDPOINT=${VITE_MINIO_ENDPOINT}'
      - 'VITE_RAPIDAPI_KEY=${VITE_RAPIDAPI_KEY}'
      - 'VITE_TOMTOM_API_KEY=${VITE_TOMTOM_API_KEY}'
      - 'REPLIT_DEV_DOMAIN=${REPLIT_DEV_DOMAIN:-best-chauffeurs.com}'
    restart: unless-stopped
    # CRITICAL: Wait for Database and MinIO to be ready
    depends_on:
      database:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - wget
        - '--quiet'
        - '--tries=1'
        - '--spider'
        - 'http://localhost:5000/health'
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3
    networks:
      - coolify
      - internal_backend

volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local